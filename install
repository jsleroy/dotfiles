#!/bin/bash
#-------------------------------------------------------------------------------
# dotfiles installation script
#-------------------------------------------------------------------------------

CACHE=install.cache

set -e

source install.rc

# Add script and configuration file to the exclude list
EXCLUDE=( install *.old $CACHE ${EXCLUDE[@]} )

# Help message
# Add this option
# -e FILE  Exclude list file
usage()
{
cat << EOF
usage: $0 [OPTIONS]

This script create symlinks in \$HOME for all files found in this directory.

OPTIONS:
    -u  uninstall dotfiles
    -v  increase verbosity
    -h  show this message and exit
EOF
}

# Parse command line options
while getopts "uvh" OPTION
do
  case $OPTION in
    v) set -x;;
    h) usage; exit 0;;
    ?) usage; exit 1;;
  esac
done

# Get list of dotfiles
FILES=`ls`

# Remove excluded files
for exclude in ${EXCLUDE[@]}
do
   FILES=(${FILES[@]/$exclude})
done

# Remove previously installed dotfiles
if [ -a $CACHE ]; then
  for filename in $(cat $CACHE)
  do
    [ -L $filename ] && unlink $filename
  done
fi

rm -f $CACHE
touch $CACHE

# Install dotfiles
for filename in ${FILES[@]}
do
    src=$(readlink -f $(pwd)/$filename)
    dst=$HOME/.$filename

    [ -a $dst ] && mv $dst ${src}.old
    ln -s $src $dst

    echo $dst >> $CACHE
done

# Display symlinks
find ~ -maxdepth 1 -type l -ls
